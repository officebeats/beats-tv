<div
  id="tile-{{ id }}"
  placement="top"
  tabindex="0"
  (keyup.enter)="click()"
  [class.playing]="starting"
  [class.faded]="fade"
  [class.three-lines]="threeLines"
  [class.compact]="compact"
  [class.selected]="selected"
  [ngbTooltip]="channel?.name"
  triggers="hover"
  (click)="click()"
  class="channel"
  (contextmenu)="onRightClick($event)"
>
  <!-- Content Row -->
  <div class="channel-content-row">
    <!-- Logo -->
    <div class="image-container">
      <img
        (error)="showImage = false"
        class="channel-image"
        *ngIf="channel?.image && showImage"
        [src]="channel?.image"
        alt="{{ channel?.name }}"
        loading="lazy"
      />
      <div class="image-placeholder" *ngIf="!channel?.image || !showImage">
        <span class="placeholder-text">{{ channel?.name || "?" | slice: 0 : 1 }}</span>
      </div>
    </div>

    <!-- Info Column -->
    <div class="channel-info-col">
      <div class="channel-header">
        <div class="channel-title" [title]="channel?.name">{{ channel?.name }}</div>

        <!-- Meta / Badges -->
        <div class="channel-badges">
          <span class="badge-live" *ngIf="channel?.media_type === mediaTypeEnum.livestream"
            >LIVE</span
          >
          <span class="badge-series" *ngIf="channel?.media_type === mediaTypeEnum.serie"
            >SERIES</span
          >

          <!-- Rating Badge -->
          <span
            class="badge-rating"
            [class.rating-high]="(channel?.rating ?? 0) >= 7"
            [class.rating-medium]="(channel?.rating ?? 0) >= 5 && (channel?.rating ?? 0) < 7"
            [class.rating-low]="(channel?.rating ?? 0) < 5"
            *ngIf="channel?.rating && (channel?.rating ?? 0) > 0"
          >
            {{ channel?.rating | number: "1.0-1" }}
          </span>

          <!-- Year Badge -->
          <span
            class="badge-year"
            *ngIf="channel?.release_date && channel?.media_type !== mediaTypeEnum.livestream"
          >
            {{ channel?.release_date | slice: 0 : 4 }}
          </span>
        </div>
      </div>

      <!-- Progress Bar -->
      <div class="progress-container">
        <div class="progress-bar"></div>
      </div>
    </div>
  </div>

  <!-- Actions Overlay (Hover) -->
  <div class="channel-actions">
    <app-icon
      *ngIf="channel?.favorite"
      name="star"
      size="md"
      class="action-icon fav-active"
      aria-hidden="true"
    ></app-icon>
  </div>

  <!-- Selection Check -->
  <div class="selection-indicator" *ngIf="selectionMode && selected">
    <app-icon name="check" size="md" aria-hidden="true"></app-icon>
  </div>
</div>

<div
  class="hidden-menu-trigger"
  [style.left.px]="menuTopLeftPosition.x"
  [style.top.px]="menuTopLeftPosition.y"
  [matMenuTriggerFor]="rightMenu"
></div>

<mat-menu #rightMenu="matMenu">
  <ng-template matMenuContent let-item="item">
    <button [hidden]="viewMode != viewModeEnum.History" mat-menu-item (click)="removeFromHistory()">
      Remove
    </button>
    <button
      [hidden]="
        channel?.media_type == mediaTypeEnum.group ||
        channel?.media_type == mediaTypeEnum.season ||
        viewMode == viewModeEnum.History
      "
      mat-menu-item
      (click)="favorite()"
    >
      <ng-container *ngIf="alreadyExistsInFav">Unfavorite</ng-container>
      <ng-container *ngIf="!alreadyExistsInFav">Favorite</ng-container>
    </button>
    <button
      [hidden]="isCustom() || viewMode == viewModeEnum.History"
      mat-menu-item
      (click)="hide()"
    >
      <ng-container *ngIf="alreadyHidden">Unhide</ng-container>
      <ng-container *ngIf="!alreadyHidden">Hide</ng-container>
    </button>
    <button [hidden]="!isLivestream()" mat-menu-item (click)="record()">Record</button>
    <button [hidden]="!isMovie() || downloading" mat-menu-item (click)="downloadVod()">
      Download
    </button>
    <button [hidden]="!isMovie() || !downloading" mat-menu-item (click)="cancelDownload()">
      Cancel download
    </button>
    <button [hidden]="!showEPG()" mat-menu-item (click)="showEPGModal()">EPG</button>
    <button [hidden]="!isCustom()" mat-menu-item (click)="edit()">Edit</button>
    <button [hidden]="!isCustom()" mat-menu-item (click)="share()">Share</button>
    <button [hidden]="!isLivestream()" mat-menu-item (click)="openRestreamModal()">
      Re-stream
    </button>
    <button [hidden]="!isCustom()" mat-menu-item (click)="delete()">Delete</button>
  </ng-template>
</mat-menu>
